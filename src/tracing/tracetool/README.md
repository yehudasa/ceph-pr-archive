# Tracetool

#### Disclaimer
This approach and some of its code are taken from the QEMU project.

## Events files and subsystems

All events are declared in text files under ``src/tracing/tracetool/subsys/`` using the following format:

```
[disable] <name>(<type1> <arg1>[, <type2> <arg2>] ...) "<format-string>" <log level>
```
For example:
```
read(uint64_t offset, size_t length, int r) "Reading %llu ~ %u $d" 10
```
Where ``read`` is the tracepoint name, ``offset``, ``length`` and ``r`` are the payload, ``"Reading %llu ~ %u $d"`` is how it will be formatted (for certain backends only) and ``10`` is its loglevel. The name of the file will be used as a subsystem (for LTTng only). This tracepoint can be invoked in the code as follows:
```
trace_read(my_offset, the_length, result);
```
All tracepoints can be called using the ``trace_<tracepoint name>()`` function.
To disable the tracepoint, simply add ``disable`` at the beginning of the line.

#### How do I add a new sybsystem?
- Create a new file under ``src/tracing/tracetool/subsys/`` and name it ``<your subsys name>``
- Fill it using the format explained above
- Add ``<your subsys name>.tp`` in ``src/tracing/CMakeLists.txt`` at the following line:
```
set(logging_tps [...] <your subsys name>.tp)
```
- ``#Include`` ``<your subsys name>_impl.h`` in the source file where you want to invoke its tracepoints

## Tracetool

The tracetool uses these events files to generate code that can be built with Ceph. The tracetool is invoked as follows:
```
python src/tracing/tracetool/tracetool.py -b <backend> -t <type>
```
Where ``backend`` is either ``dout`` or ``lttng``, and ``type`` is either ``tp`` (tracepoint file), ``c`` (C source file) or ``h`` (header file).

### How do I run this?
You don't have to, just run ``do_cmake`` with ``-DWITH_LTTNG_LOGGING=ON`` to use the ``LTTng`` backend, otherwise leave it unset to use the ``dout`` backend.

### What are the generated files?
Three files are generated for the ``lttng`` backend, and one file is generated for the ``dout`` backend. Below are some details:

#### LTTng backend
- ``<subsys>.tp`` file: contains the declaration of the tracepoint as expected by the ``lttng-gen-tp`` tool.
- ``<subsys>.c`` file: includes the header generated by the ``lttng-gen-tp`` tool, and will be built into the object file implementing the tracepoints.
- ``<subsys>_impl.h`` file: this is the file that should be included in Ceph's code in order to invoke the tracepoints. It implements all ``trace_<tracepoint>()`` functions. Following our example above, this file would have the following lines:
```
void trace_read(uint64_t offset, size_t length, int r)
{
    tracepoint(subsys, read, offset, length, r);
}
```

#### dout backend
- ``<subsys>.tp`` file: not used.
- ``<subsys>.c`` file: not used.
- ``<subsys>_impl.h`` file: this is the file that should be included in Ceph's code in order to invoke the tracepoints. It implements all trace_<tracepoint>() functions. Following our example above, this file would have the following lines:
```
#define trace_read(offset, length, r) do { dout(<loglevel>) << "Reading " << offset << " ~ " << length << " " << r << dendl; } while(0);
```
Note: We use ``#define``s for ``dout`` for now because it requires other variables to be defined (``dout_context`` and ``dout_subsys``).

## Tracing

- Have LTTng installed. Make sure that:
    - packages `lttng-tools`, `lttng-ust`, `lttng-modules` (), `babeltrace`, as well as their `-devel` counterparts when available, are installed
    - the `lttng-sessiond` daemon is running (`$> sudo lttng-sessiond -d` otherwise)
    - you belong to the `tracing` group, otherwise you'll have to run the following commands with `sudo`
- Start LTTng tracing:
    - If you have Ceph (or fio with the objectstore backend) already running, you can list the tracepoints using ``$> lttng list -u``
    - Create a tracing session: ``$> lttng create -o .``. The trace will be written in the local directory and will be called ``ust/``
    - Enable tracepoints: ``$> lttng enable-event -u -a`` to enable all userspace tracepoints. If you wish to enable only some subsystems, use ``$> lttng enable-event -u bluestore:*``. Replace ``bluestore`` with the subsystem you want to enable. You can run this command multiple times for each subsystem.
    - Start tracing: ``$> lttng start``
    - Do something with Ceph (or with fio using the objectstore backend)
    - Stop tracing: ``$> lttng stop``
    - Read the trace: ``$> lttng view`` or ``$> babeltrace <path to trace>`` (eg ``babeltrace ust/``)
    - Destroy the tracing session: ``$> lttng destroy``

## Misc
### Babeltrace
You can use Babeltrace's python bindings to parse a trace. This can be useful to write scripts that analyze a trace and extract metrics out of it.

