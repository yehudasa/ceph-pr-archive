# Tracetool

#### Disclaimer
This approach is taken from the QEMU project.

## Events file

All events are declared in text files under ``src/tracing/tracetool/subsys/`` using the following format:

```
[disable] <name>(<type1> <arg1>[, <type2> <arg2>] ...) "<format-string>" <log level>
```
For example:
```
read(uint64_t offset, size_t length, int r) "Reading %llu ~ %u $d" 10
```
Where ``read`` is the tracepoint name, ``offset``, ``length`` and ``r`` are the payload, ``"Reading %llu ~ %u $d"`` is how it will be formatted (for certain backends only) and ``10`` is its loglevel. The name of the file will be used as a subsystem (for LTTng only). This tracepoint can be invoked in the code as follows:
```
trace_read(my_offset, the_length, result);
```
All tracepoints can be called using the ``trace_<tracepoint name>()`` function.
To disable the tracepoint, simply add ``disable`` at the beginning of the line.

## Tracetool

The tracetool uses these events files to generate code that can be built with Ceph. The tracetool is invoked as follows:
```
python src/tracing/tracetool/tracetool.py -b <backend> -t <type>
```
Where ``backend`` is either ``dout`` or ``lttng``, and ``type`` is either ``tp`` (tracepoint file), ``c`` (C source file) or ``h`` (header file).

### What are the generated files?
Three files are generated for the ``lttng`` backend, and one file is generated for the ``dout`` backend.

#### LTTng backend
- ``<subsys>.tp`` file: contains the declaration of the tracepoint as expected by the ``lttng-gen-tp`` tool.
- ``<subsys>.c`` file: includes the header generated by the ``lttng-gen-tp`` tool, and will be built into the object file implementing the tracepoints.
- ``<subsys>_impl.h`` file: this is the file that should be included in Ceph's code in order to invoke the tracepoints. It implements all trace_<tracepoint>() functions. Following our example above, this file would have the following lines:
```
void trace_read(uint64_t offset, size_t length, int r)
{
    tracepoint(subsys, read, offset, length, r);
}
```

#### dout backend
- ``<subsys>.tp`` file: not used.
- ``<subsys>.c`` file: not used.
- ``<subsys>_impl.h`` file: this is the file that should be included in Ceph's code in order to invoke the tracepoints. It implements all trace_<tracepoint>() functions. Following our example above, this file would have the following lines:
```
#define trace_read(offset, length, r) dout(<loglevel>) << "Reading " << offset << " ~ " << length << " " << r << dendl;
```

